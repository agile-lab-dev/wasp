image: alpine

variables:
  SBT_VERSION: "1.0.3"
  SBT_OPTS: "-Xmx2G -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:MaxPermSize=2G -Xss2M  -Duser.timezone=GMT -Dsbt.global.base=sbt-cache/.sbtboot -Dsbt.boot.directory=sbt-cache/.boot -Dsbt.repository.config=repositories -Dsbt.ivy.home=sbt-cache/.ivy"
stages:
  - compile_publish

# https://gitlab.com/gitlab-org/gitlab-ce/issues/18106
# https://github.com/IlyaSemenov/gitlab-ci-git-push
#release:
#  stage: release
#  image: "hseeberger/scala-sbt:8u151-2.12.4-1.0.2"
#  only:
#    refs:
#     - master
#  script:
#    - sbt -v release with-defaults

# jobs for internal uses
compile_publish_internal:
  tags:
    - criticalcase
  stage: compile_publish
  image: "hseeberger/scala-sbt:8u151-2.12.4-1.0.2"
  only:
    refs:
      - develop
  cache:
    key: "$CI_BUILD_REF_NAME" # contains either the branch or the tag, so it's caching per branch
    paths:
      - "sbt-cache/.ivy/cache"
      - "sbt-cache/.boot"
      - "sbt-cache/.sbtboot"
      - "*/target/streams"
  before_script:
      - >
         echo "[repositories]
              maven-proxy-snapshots: ${NEXUS_URL}/repository/maven-snapshots/
              maven-proxy-releases: ${NEXUS_URL}/repository/maven-releases/
              maven-proxy-central:  ${NEXUS_URL}/repository/maven-central/
              maven-central" > repositories
  script:
    - sbt -v publish

# jobs for public uses
compile_publish_public:
  tags:
    - cluster01
  stage: compile_publish
  image: "hseeberger/scala-sbt:8u151-2.12.4-1.0.2"
  only:
    refs:
      - develop
  script:
    - ls -lha
    - sbt -v publish